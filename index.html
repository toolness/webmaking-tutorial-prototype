<!DOCTYPE html>
<meta charset="utf-8">
<title>Learn HTML! Yay!</title>
<link rel="stylesheet" href="codemirror2/lib/codemirror.css">
<link rel="stylesheet" href="jsbin-codemirror-theme.css">
<style>
html {
  background: #303030;
  height: 100%;
}

body {
  width: 900px;
  height: 100%;
  background: white;
  margin: 0 auto;
}

#editor {
  display: inline-block;
  vertical-align: bottom;
  width: 450px;
  height: 400px;
  border-top: 1px solid gray;
  border-right: 1px solid gray;
  border-bottom: 1px solid gray;
  -moz-box-sizing:    border-box;
  -webkit-box-sizing: border-box;
   box-sizing:        border-box;
}

#preview {
  display: inline-block;
  vertical-align: bottom;
  width: 450px;
  height: 400px;
  border: none;
  border-top: 1px solid gray;
  border-bottom: 1px solid gray;
  -moz-box-sizing:    border-box;
  -webkit-box-sizing: border-box;
   box-sizing:        border-box;
}

.CodeMirror {
  width: 100%;
  height: 100%;
}

#mascot {
  height: 200px;
  padding-top: 10px;
  padding-bottom: 10px;
  padding-left: 10px;
}

#dialogue {
  font-family: "Comic Sans MS";
  font-size: 40px;
  float: right;
  width: 700px;
  padding-top: 10px;
  padding-right: 10px;
}

.spotlight {
  position: absolute;
  border: 3px solid blue;
  z-index: 10000;
  -moz-box-sizing:    border-box;
  -webkit-box-sizing: border-box;
   box-sizing:        border-box;
}
</style>
<div id="instructions">
  <img id="mascot" src="lovebomb-person.svg">
  <div id="dialogue"></div>
</div>
<div id="editor"></div><iframe id="preview"></iframe>
<script src="jquery.min.js"></script>
<script src="codemirror2/lib/codemirror.js"></script>
<script src="codemirror2/mode/xml/xml.js"></script>
<script src="codemirror2/mode/javascript/javascript.js"></script>
<script src="codemirror2/mode/css/css.js"></script>
<script src="codemirror2/mode/htmlmixed/htmlmixed.js"></script>
<script>
var DEFAULT_DURATION_MS = 3000;
var nextUpdateIsSilent = false;
var nextUpdateIsInstant = false;
var scriptSections = [];
var sectionInProgress = false;
var scheduleSectionInterrupt = null;
var editor;

onhashchange = function() {
  if (sectionInProgress) {
    scheduleSectionInterrupt();
    return;
  }
  var section = parseInt(window.location.hash.slice(1));
  if (isNaN(section) || section < 0)
    section = 0;
  if (section >= scriptSections.length)
    section = scriptSections.length - 1;
  sectionInProgress = true;
  var sectionInterrupted = false;
  scheduleSectionInterrupt = function() {
    sectionInterrupted = true;
  };
  var command = scriptSections[section];
  console.log("playing command " + command.role);
  var deferred = command.play();
  deferred.done(function() {
    if (sectionInterrupted) {
      sectionInProgress = false;
      onhashchange();
      return;
    }
    var duration = DEFAULT_DURATION_MS;
    if (typeof(command.pauseAfter) == "number")
      duration = command.pauseAfter;
    var timeout = setTimeout(function() {
      sectionInProgress = false;
      if (section+1 < scriptSections.length)
        window.location.hash = "#" + (section+1);
    }, duration);
    scheduleSectionInterrupt = function() {
      clearTimeout(timeout);
      sectionInProgress = false;
      onhashchange();
    }
  });
}

function startPlayingScript(html) {
  var div = $("<div></div>");
  div.html(html);
  div.find("section").each(function() {
    var role = $(this).attr("data-role");
    var command = Commands[role]($(this));
    command.role = role;
    console.log("adding command " + role);
    scriptSections.push(command);
  });
  onhashchange();
}

var Commands = {
  dialogue: function(section) {
    var duration = parseInt($(section).attr("data-duration"));
    if (isNaN(duration))
      duration = null;
    return {
      play: function() {
        var deferred = new jQuery.Deferred();
        $("#dialogue").fadeOut(function() {
          $(this).html(section.html()).fadeIn(function() {
            deferred.resolve();
          });
        });
        return deferred;
      },
      pauseAfter: duration
    };
  },
  moveto: function(section) {
    return {
      play: function() {
        var deferred = jQuery.Deferred();
        var position = section.attr("data-position");
        var search = section.text();
        deferred.resolve();
        if (search.length) {
          var cursor = editor.getSearchCursor(search);
          cursor.findNext();
          if (position == "beginning") {
            editor.setCursor(cursor.from());
          } else if (position == "end") {
            editor.setCursor(cursor.to());
          }
          return deferred;
        }
        if (position == "beginning") {
          editor.setCursor(0, 0);
        } else if (position == "end") {
          editor.setCursor(9999999999, 999999999999);
        }
        return deferred;
      },
      pauseAfter: 0
    };
  },
  clear: function(section) {
    return {
      play: function() {
        editor.setValue("");
        var deferred = jQuery.Deferred();
        deferred.resolve();
        return deferred;
      },
      pauseAfter: 0
    }
  },
  typechars: function(section) {
    return {
      play: function() {
        editor.focus();
        var characters = section.text();
        var deferred = jQuery.Deferred();
        var array = [];
        for (var i = 0; i < characters.length; i++)
          array.push(characters.charAt(i));
        array.reverse();
        var interval = setInterval(function() {
          if (array.length)
            editor.replaceRange(array.pop(), editor.getCursor());
            //editor.setValue(editor.getValue() + array.pop());
          else {
            clearInterval(interval);
            deferred.resolve();
          }
        }, 500);
        return deferred;
      }
    };
  },
  spotlight: function(section) {
    var target = $(section.attr("data-selector"));
    return {
      play: function() {
        var bounds = target[0].getBoundingClientRect();
        var spotlight = $('<div class="spotlight"></div>');
        spotlight.css({
          top: bounds.top + 'px',
          left: bounds.left + 'px',
          width: bounds.width + 'px',
          height: bounds.height + 'px'
        });
        $(document.documentElement).append(spotlight);
        var deferred = jQuery.Deferred();
        spotlight.hide().fadeIn("slow", function() {
          setTimeout(function() {
            spotlight.fadeOut("slow", function() {
              spotlight.remove();
              deferred.resolve();
            });
          }, 3000);
        });
        return deferred;
      },
      pauseAfter: 0
    };
  }
}

function initEditor() {
  var DELAY_MS = 300;
  var delay = null;
  editor = CodeMirror(function(element) {
    $("#editor").append(element);
  }, {
    mode: "text/html",
    theme: "jsbin",
    tabMode: "indent",
    lineWrapping: true,
    lineNumbers: true,
    onChange: function schedulePreviewRefresh() {
      if (nextUpdateIsSilent) {
        nextUpdateIsSilent = false;
      } else {
        clearTimeout(delay);
        if (nextUpdateIsInstant) {
          nextUpdateIsInstant = false;
          updatePreview();
        } else
          delay = setTimeout(updatePreview, DELAY_MS);
      }
    }
  });

  function updatePreview() {
    var previewDocument = $("#preview").contents()[0];
    previewDocument.open();
    previewDocument.write(editor.getValue());
    previewDocument.close();
  }
  updatePreview();
}

var scriptHtmlLoad = jQuery.get("script.html");

$(window).load(function() {
  scriptHtmlLoad.done(function(html) {
    initEditor();
    startPlayingScript(html);
  });
});
</script>
