<!DOCTYPE html>
<meta charset="utf-8">
<title>Learn HTML! Yay!</title>
<link rel="stylesheet" href="codemirror2/lib/codemirror.css">
<link rel="stylesheet" href="jsbin-codemirror-theme.css">
<style>
html {
  background: #303030;
  height: 100%;
}

body {
  width: 900px;
  height: 100%;
  background: white;
  margin: 0 auto;
}

#editor {
  display: inline-block;
  vertical-align: bottom;
  width: 450px;
  height: 400px;
  border-top: 1px solid gray;
  border-right: 1px solid gray;
  border-bottom: 1px solid gray;
  -moz-box-sizing:    border-box;
  -webkit-box-sizing: border-box;
   box-sizing:        border-box;
}

#preview {
  display: inline-block;
  vertical-align: bottom;
  width: 450px;
  height: 400px;
  border: none;
  border-top: 1px solid gray;
  border-bottom: 1px solid gray;
  -moz-box-sizing:    border-box;
  -webkit-box-sizing: border-box;
   box-sizing:        border-box;
}

.CodeMirror {
  width: 100%;
  height: 100%;
}

#mascot {
  height: 200px;
  padding-top: 10px;
  padding-bottom: 10px;
  padding-left: 10px;
}

#dialogue {
  font-family: "Comic Sans MS";
  font-size: 40px;
  float: right;
  width: 700px;
  padding-top: 10px;
  padding-right: 10px;
  -moz-transition: opacity 0.5s;
  -webkit-transition: opacity 0.5s;
  -o-transition: opacity 0.5s;
  -ms-transition: opacity 0.5s;
  opacity: 0;
}

#dialogue.visible {
  opacity: 1;
}

.spotlight {
  position: absolute;
  border: 1px solid blue;
  box-shadow: 0 0 10px blue;
  z-index: 10000;
  -moz-box-sizing:    border-box;
  -webkit-box-sizing: border-box;
   box-sizing:        border-box;
  -moz-transition: opacity 0.25s;
  -webkit-transition: opacity 0.25s;
  -o-transition: opacity 0.25s;
  -ms-transition: opacity 0.25s;
  opacity: 0;
}

.spotlight.visible {
  opacity: 1;
}

#player {
  font-family: Monaco, "Lucida Console", monospace;
  font-size: 10px;
  position: fixed;
  color: white;
  background: rgba(0, 0, 0, 0.75);
  padding: 4px;
  bottom: 0px;
  right: 0px;
}

#player .scrubber {
  width: 100px;
}

#player .timestamp {
  min-width: 40px;
}

#player .scrubber .progress {
  background: rgba(255, 255, 255, 0.8);
  min-height: 10px;
  vertical-align: middle;
}

#player div {
  display: inline-block;
}
</style>
<div id="instructions">
  <img id="mascot" src="lovebomb-person.svg">
  <div id="dialogue"></div>
</div>
<div id="editor"></div><iframe id="preview"></iframe>
<div id="player">
  <div class="scrubber"><div class="progress"></div></div>
  <div class="timestamp"></div>
</div>
<script src="jquery.min.js"></script>
<script src="codemirror2/lib/codemirror.js"></script>
<script src="codemirror2/mode/xml/xml.js"></script>
<script src="codemirror2/mode/javascript/javascript.js"></script>
<script src="codemirror2/mode/css/css.js"></script>
<script src="codemirror2/mode/htmlmixed/htmlmixed.js"></script>
<script src="popcorn.js"></script>
<script src="popcorn.baseplayer.js"></script>
<script>
var nextUpdateIsSilent = false;
var nextUpdateIsInstant = false;
var editor;
var pop;

jQuery.fn.extend({
  attrFloat: function(name, defaultValue) {
    var number = parseFloat(this.attr(name));
    if (isNaN(number))
      return defaultValue;
    return number;
  }
});

Popcorn.plugin("simplecode", function(options, f) {
  return {
    start: function(event, options) {
      var myIndex = this.data.trackEvents.byStart.indexOf(options);
      var events = this.data.trackEvents.byStart;
      var futureEvents = events.slice(myIndex+1);
      var pastEvents = events.slice(0, myIndex);
      futureEvents.reverse().forEach(function(event) {
        if (event.isUndoable && event.executed)
          event.undo();
      });
      pastEvents.forEach(function(event) {
        if (event.isUndoable && !event.executed)
          event.onStart();
      });
      if (options.onStart)
        options.onStart();
    },
    end: function(event, options) {
      if (options.onEnd)
        options.onEnd();
    }
  };
});

function undoable(options) {
  var onStart = options.onStart;
  var undo = options.undo;

  options.isUndoable = true;
  options.executed = false;
  options.onStart = function() {
    if (!this.executed) {
      this.executed = true;
      onStart.call(this);
    }
  };
  options.undo = function() {
    if (this.executed) {
      this.executed = false;
      undo.call(this);
    }
  };
  return options;
}

onhashchange = function() {
  var time = parseFloat(window.location.hash.slice(1));
  if (isNaN(time))
    time = 0;
  if (pop)
    pop.play(time);
};

$("#player .scrubber").mousedown(function(event) {
  var self = $(this);

  function scrub(event) {
    var baseX = self.offset().left;
    var width = self.width();
    var percentage = (event.pageX - baseX) / width;
    pop.media.currentTime = pop.media.duration * percentage;
    pop.media.dispatchEvent("timeupdate");
  }
  
  self.bind("mousemove", function(event) {
    scrub(event);
  });
  $(document).one("mouseup", function() {
    self.unbind("mousemove");
    pop.play();
  });
  
  pop.pause();
  scrub(event);
  return false;
});

function updatePlayerUI() {
  var media = pop.media;
  var percentComplete = (media.currentTime / media.duration) * 100;
  $("#player .progress").css({
    width: percentComplete + "%"
  });
  $(".timestamp").text(media.currentTime.toFixed(1).toString() + 's');  
}

function startPlayingScript(html) {
  var media = new Popcorn.baseplayer();
  var div = $("<div></div>");
  media.addEventListener("timeupdate", function() {
    if (this.currentTime >= this.duration) {
      this.currentTime = this.duration;
      this.pause();
    }
    updatePlayerUI();
  });
  pop = Popcorn(media);
  div.html(html);
  div.find("section").each(function() {
    var command = Commands[$(this).attr("data-role")];
    $(this).data("command", command);
    $(this).attr("data-start", media.duration);
    media.duration += command.duration($(this));
  }).each(function() {
    $(this).data("command").annotate($(this), pop);
  });
  media.readyState = 4;
  onhashchange();
}

var Commands = {
  dialogue: {
    TRANSITION_TIME: 0.5,
    duration: function(section) {
      var duration = section.attrFloat("data-duration", 3);
      return duration || 0.05;
    },
    annotate: function(section, pop) {
      var nextDialogue = section.nextAll('section[data-role="dialogue"]');
      var end = pop.media.duration + 1;
      if (nextDialogue.length)
        end = nextDialogue.attrFloat("data-start") - this.TRANSITION_TIME;
      pop.simplecode({
        start: section.attrFloat("data-start"),
        end: end,
        onStart: function() {
          $("#dialogue").html(section.html());
          $("#dialogue").addClass('visible');
        },
        onEnd: function() {
          $("#dialogue").removeClass('visible');
        }
      });
    }
  },
  moveto: {
    duration: function(section) {
      return 0.1;
    },
    annotate: function(section, pop) {
      var position = section.attr("data-position");
      var search = section.text();
      var start = section.attrFloat("data-start");
      pop.simplecode(undoable({
        start: start,
        end: start + this.duration(section),
        onStart: function() {
          if (search.length) {
            this._oldCursor = editor.getCursor();
            var cursor = editor.getSearchCursor(search);
            cursor.findNext();
            if (position == "beginning") {
              editor.setCursor(cursor.from());
            } else if (position == "end") {
              editor.setCursor(cursor.to());
            }
            return;
          }
          if (position == "beginning") {
            editor.setCursor(0, 0);
          } else if (position == "end") {
            editor.setCursor(9999999999, 999999999999);
          }
        },
        undo: function() {
          editor.setCursor(this._oldCursor);
        }
      }));
    }
  },
  typechars: {
    DURATION_PER_CHAR: 0.4,
    duration: function(section) {
      return section.text().length * this.DURATION_PER_CHAR;
    },
    annotate: function(section, pop) {
      var self = this;
      var characters = section.text();
      var array = [];
      var currentTime = section.attrFloat("data-start");
      for (var i = 0; i < characters.length; i++)
        array.push(characters.charAt(i));
      array.forEach(function(character) {
        pop.simplecode(undoable({
          start: currentTime,
          end: currentTime + self.DURATION_PER_CHAR,
          onStart: function() {
            this._oldCursor = editor.getCursor();
            editor.focus();
            editor.replaceRange(character, editor.getCursor());
          },
          undo: function() {
            editor.replaceRange("", this._oldCursor, editor.getCursor());
          }
        }));
        currentTime += self.DURATION_PER_CHAR;
      });
    }
  },
  spotlight: {
    TRANSITION_TIME: 0.25,
    duration: function(section) {
      return 3;
    },
    annotate: function(section, pop) {
      var self = this;
      var start = section.attrFloat("data-start");
      pop.simplecode({
        start: start,
        end: start + this.duration(section) - this.TRANSITION_TIME,
        onStart: function() {
          var target = $(section.attr("data-selector"));
          var bounds = target[0].getBoundingClientRect();
          var spotlight = $('<div class="spotlight"></div>');
          spotlight.css({
            top: bounds.top + 'px',
            left: bounds.left + 'px',
            width: bounds.width + 'px',
            height: bounds.height + 'px'
          });
          $(document.documentElement).append(spotlight);
          setTimeout(function() { spotlight.addClass("visible"); }, 0);
          this._spotlight = spotlight;
        },
        onEnd: function() {
          var spotlight = $(this._spotlight);
          delete this._spotlight;
          spotlight.removeClass("visible");
          setTimeout(function() {
            spotlight.remove();
          }, self.TRANSITION_TIME * 1000);
        }
      });
    }
  }
}

function initEditor() {
  var DELAY_MS = 300;
  var delay = null;
  editor = CodeMirror(function(element) {
    $("#editor").append(element);
  }, {
    mode: "text/html",
    theme: "jsbin",
    tabMode: "indent",
    lineWrapping: true,
    lineNumbers: true,
    onChange: function schedulePreviewRefresh() {
      if (nextUpdateIsSilent) {
        nextUpdateIsSilent = false;
      } else {
        clearTimeout(delay);
        if (nextUpdateIsInstant) {
          nextUpdateIsInstant = false;
          updatePreview();
        } else
          delay = setTimeout(updatePreview, DELAY_MS);
      }
    }
  });

  function updatePreview() {
    var previewDocument = $("#preview").contents()[0];
    previewDocument.open();
    previewDocument.write(editor.getValue());
    previewDocument.close();
  }
  updatePreview();
}

var scriptHtmlLoad = jQuery.get("script.html");

$(window).load(function() {
  scriptHtmlLoad.done(function(html) {
    initEditor();
    startPlayingScript(html);
  });
});
</script>
